CSOURCES=$(shell find -name *.c -not -path "./crt")
COBJECTS=$(patsubst %.c, %.o, $(CSOURCES))
CPPSOURCES=$(shell find -name *.cpp -not -path "./crt")
CPPOBJECTS=$(patsubst %.cpp, %.o, $(CPPSOURCES))
SSOURCES=$(shell find -name *.s)
SOBJECTS=$(patsubst %.s, %.o, $(SSOURCES))


CC=$$HOME/opt/cross/bin/x86_64-elf-gcc
CPP=$$HOME/opt/cross/bin/x86_64-elf-gcc
LD=$$HOME/opt/cross/bin/x86_64-elf-gcc
AS=$$HOME/opt/cross/bin/x86_64-elf-as
#CPP=clang


all: build test

build: clean check $(COBJECTS) $(CPPOBJECTS) $(SOBJECTS) link

test: mkiso runem


WFLAGSON=-Wall -Wextra -Werror=return-type -Wshadow -Wframe-larger-than=16384 -Wdeprecated -Wredundant-decls -pedantic
WFLAGSOFF=-Wno-sequence-point -Wno-unused-parameter -Wno-sign-compare
FFLAGS=-fno-omit-frame-pointer -ffreestanding -fno-rtti -fno-exceptions -fno-stack-protector
DFLAGS=-DARCH=x64 -DVENDOR=IBM
MFLAGS=-mcmodel=kernel -mno-red-zone -mno-sse3 -mno-3dnow
CFLAGS=-Isrc/stdlib/include -O2 -std=c99 $(DFLAGS) $(WFLAGSON) $(WFLAGSOFF) $(FFLAGS) $(MFLAGS)
CPPFLAGS=-Isrc/stdlib/include -Isrc/hal -O2 -std=c++11 $(DFLAGS) $(WFLAGSON) $(WFLAGSOFF) $(FFLAGS) $(MFLAGS)
LDFLAGS=-Tlinkx64.ld -z max-page-size=0x1000 -ffreestanding -O2 -nostdlib -lgcc $(FFLAGS)
ASFLAGS=-felf64


clean:
	@echo Cleaning workspace
	@find . -name '*.o' -delete
	@rm -f kernel

check:
	@tools/doccheck.py kernel src
link:
	@echo Linking
	@$(LD) $(LDFLAGS) -o kernel $(SOBJECTS) $(COBJECTS) $(CPPOBJECTS)

.s.o:
	@echo Assembling $(patsubst %.o, %.s, $@)
	@cpp -E -P $(DFLAGS) -o $(patsubst %.o, %.cpps, $@) $(patsubst %.o, %.s, $@)
	@nasm $(ASFLAGS) $(patsubst %.o, %.cpps, $@) -o $@
	@rm $(patsubst %.o, %.cpps, $@)

.c.o:
	@echo Compiling $<
	@$(CC) $(CFLAGS) -o $@ -c $<

.cpp.o:
	@echo Compiling $<
	@$(CPP) $(CPPFLAGS) -o $@ -c $<

mkiso:
	#@tools/packrd.py
	#@tools/symexport.py kernel
	@cp -f kernel iso/kernel
	@cp -f kernel.sym iso/kernel.sym
	#@cp -f initrd.rd iso/initrd.rd
	@grub2-mkrescue -o bootable.iso iso -- -zisofs level=6

runem:
	#@~/bochs/bochs -f bochs.rc -q
	@cd .&& bash scripts/run_emulator64 `pwd` &
