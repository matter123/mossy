CSOURCES:=$(shell find src -name *.c)
COBJECTS:=$(patsubst %.c, %.o, $(CSOURCES))
CPPSOURCES:=$(shell find src -name *.cpp)
CPPOBJECTS:=$(patsubst %.cpp, %.o, $(CPPSOURCES))
SSOURCES:=$(shell find src -name *.s)
SOBJECTS:=$(patsubst %.s, %.o, $(SSOURCES))

export
ARCH:=32
CC:=$(shell echo $$HOME)/opt/cross/bin/i586-elf-gcc
CPP:=$(shell echo $$HOME)/opt/cross/bin/i586-elf-gcc
LD:=$(shell echo $$HOME)/opt/cross/bin/i586-elf-gcc
AS:=$(shell echo $$HOME)/opt/cross/bin/i586-elf-as
GAR:=$(shell echo $$HOME)/opt/cross/bin/i586-elf-ar
#CPP=clang

CRTBEGIN_OBJ:=$(shell $(CC) $(CFLAGS) -print-file-name=crtbegin.o)
CRTEND_OBJ:=$(shell $(CC) $(CFLAGS) -print-file-name=crtend.o)

all: build runem

build: clean check $(COBJECTS) $(CPPOBJECTS) $(SOBJECTS) globalc build_libs link mkiso

WFLAGSON=-Wall -Wextra -Werror=return-type -Wshadow -Wundef -Wframe-larger-than=16384 -Wdeprecated \
-Wredundant-decls
WFLAGSOFF=-Wno-sequence-point -Wno-unused-parameter -Wno-sign-compare -Wno-pointer-arith
FFLAGS=-fno-omit-frame-pointer -ffreestanding -fno-rtti -fno-exceptions -fno-stack-protector
DFLAGS=-DARCH=_x86 -DVENDOR=_PC -DDEBUG
IFLAGS=-Isrc/stdlib/include -Isrc/hal -Isrc/arch -Isrc/vendor
CFLAGS=-O2 -std=c99 $(DFLAGS) $(WFLAGSON) $(WFLAGSOFF) $(FFLAGS) $(IFLAGS)
CPPFLAGS=-O2 -std=c++11 $(DFLAGS) $(WFLAGSON) $(WFLAGSOFF) $(FFLAGS) $(IFLAGS)
LDFLAGS=-static -Tlinkx86.ld -z max-page-size=0x1000 -ffreestanding -O2 -nostdlib $(FFLAGS) -Llibs
ASFLAGS=-felf


clean:
	@echo Cleaning workspace
	@find . -name '*.o' -delete
	@rm -f kernel32

check:
	#@tools/doccheck.py kernel src
link:
	@echo Linking
	@$(LD) $(LDFLAGS) -o kernel32 ./gc/crti.o $(CRTBEGIN_OBJ) $(SOBJECTS) $(COBJECTS) $(CPPOBJECTS)\
	 $(CRTEND_OBJ) ./gc/crtn.o -lgcc

.s.o:
	@echo Assembling $(patsubst %.o, %.s, $@)
	@cpp $(CPPFLAGS) -E -P -o $(patsubst %.o, %.cpps, $@) $(patsubst %.o, %.s, $@)
	@nasm $(ASFLAGS) $(patsubst %.o, %.cpps, $@) -o $@
	@rm $(patsubst %.o, %.cpps, $@)

.c.o:
	@echo Compiling $<
	@$(CC) $(CFLAGS) -o $@ -c $<

.cpp.o:
	@echo Compiling $<
	@$(CPP) $(CPPFLAGS) -o $@ -c $<

mkiso:
	#@tools/packrd.py
	#@tools/symexport.py kernel32
	@cp -f kernel32 iso/kernel
	@cp -f kernel32.sym iso/kernel.sym
	#@cp -f initrd.rd iso/initrd.rd

runem:
	@~/bochs-2.6.2/bochs -f bochs.rc -q
	#@cd .&& bash scripts/run_emulator64 `pwd` &

globalc:
	@echo assembling help files
	@$(AS) ./gc/crti.asm -o ./gc/crti.o
	@$(AS) ./gc/crtn.asm -o ./gc/crtn.o

build_libs:
	#cd libs/hal && $(MAKE)
