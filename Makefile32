export
ARCH=86
VENDOR=PC
OBJ_SUFFIX:=$(ARCH)_$(VENDOR)
ClangXX:=clang++ --target=i686-elf -Wdocumentation
Clang:=clang --target=i686-elf -Wdocumentation
CC:=$(Clang)
CXX:=$(ClangXX)

CSOURCES:=$(shell find src -name *.c)
COBJECTS:=$(patsubst %.c, %.o.$(OBJ_SUFFIX), $(CSOURCES))
CXXSOURCES:=$(shell find src -name *.cpp)
CXXOBJECTS:=$(patsubst %.cpp, %.o.$(OBJ_SUFFIX), $(CXXSOURCES))
SSOURCES:=$(shell find src -name *.s)
SOBJECTS:=$(patsubst %.s, %.o.$(OBJ_SUFFIX), $(SSOURCES))


all: build

build: $(COBJECTS) $(CXXOBJECTS) $(SOBJECTS) build_libs link

FFLAGS=-fno-omit-frame-pointer -ffreestanding -fno-stack-protector -fno-common
DFLAGS:=$(DFLAGS) -DARCH=_x86 -DVENDOR=_PC -DDEBUG
CFLAGS=-O3 -std=c11 $(DFLAGS) $(WFLAGSON) $(WFLAGSOFF) $(FFLAGS) $(IFLAGS)
CXXFLAGS=-O3 -std=gnu++1y $(DFLAGS) $(WFLAGSON) $(WFLAGSOFF) $(FFLAGS) $(IFLAGS) -fno-rtti \
-fno-exceptions -fdiagnostics-color=auto
LDFLAGS=-static -Tbuild_files/linkx86.ld  -ffreestanding -O2 -nostdlib $(FFLAGS) -Llibs
ASFLAGS=-felf


clean:
	@echo Cleaning workspace
	@find . -name '*.o.$(OBJ_SUFFIX)' -delete
	@find . -name '*.d.$(OBJ_SUFFIX)' -delete
	@rm -f build_files/kernel$(OBJ_SUFFIX)

link:
	@echo Linking
	@$(CXX) $(LDFLAGS) -o build_files/kernel$(OBJ_SUFFIX) $(SOBJECTS) $(COBJECTS) $(CXXOBJECTS) -lc$(OBJ_SUFFIX)\
	 -lunicode$(OBJ_SUFFIX) -lacpi$(OBJ_SUFFIX) -lgcc

-include $(CXXOBJECTS:.o.$(OBJ_SUFFIX)=.d.$(OBJ_SUFFIX))
-include $(COBJECTS:.o.$(OBJ_SUFFIX)=.d.$(OBJ_SUFFIX))
-include build_files/dummy32

dummy32: Makefile32 Makefile
	@touch $@
	@$(MAKE) -f Makefile32 clean


%o.$(OBJ_SUFFIX): %s
	@echo Assembling $(patsubst %.o.$(OBJ_SUFFIX), %.s, $@)
	@cpp $(DFLAGS) $(IFLAGS) -DASM -E -P$(patsubst %.o.$(OBJ_SUFFIX), %.s, $@) -o$(patsubst %.o.$(OBJ_SUFFIX), %.cpps, $@)
	@nasm $(ASFLAGS) $(patsubst %.o.$(OBJ_SUFFIX), %.cpps, $@) -o $@
	@rm $(patsubst %.o.$(OBJ_SUFFIX), %.cpps, $@)

%o.$(OBJ_SUFFIX): %c
	@echo Compiling $<
	@$(Clang) $(CFLAGS) -o $@ -c $<
	@$(Clang) -MM $(CFLAGS) $< > $(patsubst %.o.$(OBJ_SUFFIX), %.d.$(OBJ_SUFFIX),$@)

%o.$(OBJ_SUFFIX): %cpp
	@echo Compiling $<
	@$(ClangXX) $(CXXFLAGS) -o $@ -c $<
	@$(ClangXX) -MM $(CXXFLAGS) $< > $(patsubst %.o.$(OBJ_SUFFIX), %.d.$(OBJ_SUFFIX),$@)

build_libs:
	cd libs/clib && $(MAKE) build
	cd libs/unicode && $(MAKE) build
	cd libs/acpi && $(MAKE) build
